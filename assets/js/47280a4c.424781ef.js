"use strict";(self.webpackChunkratis_tmp=self.webpackChunkratis_tmp||[]).push([[1348],{8453:(e,n,i)=>{i.d(n,{R:()=>a,x:()=>o});var r=i(6540);const s={},t=r.createContext(s);function a(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),r.createElement(t.Provider,{value:n},e.children)}},9991:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>d,contentTitle:()=>o,default:()=>h,frontMatter:()=>a,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"membership-change","title":"Membership Change","description":"Overview","source":"@site/docs/membership-change.md","sourceDirName":".","slug":"/membership-change","permalink":"/ratis-site/docs/membership-change","draft":false,"unlisted":false,"editUrl":"https://github.com/apache/ratis-site/edit/main/docs/membership-change.md","tags":[],"version":"current","frontMatter":{"title":"Membership Change"},"sidebar":"tutorialSidebar","previous":{"title":"Snapshot Guide","permalink":"/ratis-site/docs/snapshot"},"next":{"title":"Ratis-shell CLI","permalink":"/ratis-site/docs/cli"}}');var s=i(4848),t=i(8453);const a={title:"Membership Change"},o="Ratis Membership Change",d={},c=[{value:"Overview",id:"overview",level:2},{value:"Adding a new server",id:"adding-a-new-server",level:2},{value:"Removing an existing peer",id:"removing-an-existing-peer",level:2},{value:"Arbitrary configuration change",id:"arbitrary-configuration-change",level:2},{value:"<code>ADD</code> Mode and <code>COMPARE_AND_SET</code> Mode",id:"add-mode-and-compare_and_set-mode",level:2},{value:"Majority-add",id:"majority-add",level:2}];function l(e){const n={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"ratis-membership-change",children:"Ratis Membership Change"})}),"\n",(0,s.jsx)(n.h2,{id:"overview",children:"Overview"}),"\n",(0,s.jsx)(n.p,{children:"Adjusting the configuration, such as replacing failed servers or changing replication levels, is sometimes necessary in practice. Ratis facilitates these functionalities through joint consensus, allowing for simultaneous addition or replacement of multiple servers in a cluster."}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["For details on how joint consensus algorithm works, please refer to section 4.3 in ",(0,s.jsx)(n.a,{href:"https://web.stanford.edu/~ouster/cgi-bin/papers/OngaroPhD.pdf",children:"Raft Paper"})]}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"During membership changes, the availability guarantee of Raft is more vulnerable than usual. Agreement (for elections and entry commitment) requires separate majorities from both the old and new configurations. For example, when changing from a cluster of 3 servers to a different cluster of 9 servers, agreement requires both 2 of the 3 servers in the old configuration and 5 of the 9 servers in the new configuration. Be careful to keep both separate majorities online!"}),"\n",(0,s.jsx)(n.h2,{id:"adding-a-new-server",children:"Adding a new server"}),"\n",(0,s.jsxs)(n.p,{children:["To add a new node (e.g., ",(0,s.jsx)(n.code,{children:"N3"}),") to an existing group (e.g., ",(0,s.jsx)(n.code,{children:"N0"}),", ",(0,s.jsx)(n.code,{children:"N1"}),", ",(0,s.jsx)(n.code,{children:"N2"}),"), follow these steps:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Start the new peer ",(0,s.jsx)(n.code,{children:"N3"})," with ",(0,s.jsx)(n.strong,{children:"EMPTY"})," group."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"RaftServer N3 = RaftServer.newBuilder()\n  .setGroup(RaftGroup.emptygroup())\n  .setProperties(properties)\n  .setServerId(n3id)\n  .setStateMachine(userStateMachine)\n  .build();\nN3.start()\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["Invoke a ",(0,s.jsx)(n.code,{children:"setConfiguration"})," method in the ",(0,s.jsx)(n.a,{href:"https://github.com/apache/ratis/blob/master/ratis-client/src/main/java/org/apache/ratis/client/api/AdminApi.java#L44",children:"AdminApi"})," with the new group as the parameter. It will wait for the new peer to catch up before returning the reply."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"reply = client.admin().setConfiguration(List.of(N0, N1, N2, N3))\n"})}),"\n",(0,s.jsx)(n.p,{children:"\u26a0\ufe0f Note"}),"\n",(0,s.jsxs)(n.blockquote,{children:["\n",(0,s.jsxs)(n.p,{children:["Avoid starting ",(0,s.jsx)(n.code,{children:"N3"})," with the group (",(0,s.jsx)(n.code,{children:"N0"}),", ",(0,s.jsx)(n.code,{children:"N1"}),", ",(0,s.jsx)(n.code,{children:"N2"}),", ",(0,s.jsx)(n.code,{children:"N3"}),") as it may lead to shutdown scenarios, particularly if ",(0,s.jsx)(n.code,{children:"N3"})," initiates a leader election before being recognized by original peers."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"removing-an-existing-peer",children:"Removing an existing peer"}),"\n",(0,s.jsxs)(n.p,{children:["To remove an existing node (e.g., ",(0,s.jsx)(n.code,{children:"N3"}),") from a group (e.g., ",(0,s.jsx)(n.code,{children:"N0"}),", ",(0,s.jsx)(n.code,{children:"N1"}),", ",(0,s.jsx)(n.code,{children:"N2"}),", ",(0,s.jsx)(n.code,{children:"N3"}),"), follow these steps:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Issue a ",(0,s.jsx)(n.code,{children:"setConfiguration"})," request to inform about the configuration change."]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"reply = client.admin().setConfiguration(List.of(N0, N1, N2))\n"})}),"\n",(0,s.jsxs)(n.ol,{start:"2",children:["\n",(0,s.jsxs)(n.li,{children:["Check if ",(0,s.jsx)(n.code,{children:"reply.isSuccess()"})]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["Note that ",(0,s.jsx)(n.code,{children:"N3"})," will automatically shut down. The data in ",(0,s.jsx)(n.code,{children:"N3"})," can be safely deleted."]}),"\n",(0,s.jsx)(n.h2,{id:"arbitrary-configuration-change",children:"Arbitrary configuration change"}),"\n",(0,s.jsxs)(n.p,{children:["To perform multiple member changes at one time, like replacing two old nodes with new ones in a five-node cluster (changing from an existing group ","N4"," to a new group ","N6","), follow these steps:"]}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:["Start new peers with an ",(0,s.jsx)(n.strong,{children:"EMPTY"})," group."]}),"\n",(0,s.jsxs)(n.li,{children:["Issue a ",(0,s.jsx)(n.code,{children:"setConfiguration(List.of(N0, N1, N2, N5, N6))"})," request to the original group. The removed peers ",(0,s.jsx)(n.code,{children:"N3"})," and ",(0,s.jsx)(n.code,{children:"N4"})," will automatically shut down. For full code examples, see ",(0,s.jsx)(n.a,{href:"https://github.com/apache/ratis/blob/master/ratis-examples/src/main/java/org/apache/ratis/examples/membership/server/RaftCluster.java#L68",children:"examples/membership/server"}),"."]}),"\n"]}),"\n",(0,s.jsxs)(n.h2,{id:"add-mode-and-compare_and_set-mode",children:[(0,s.jsx)(n.code,{children:"ADD"})," Mode and ",(0,s.jsx)(n.code,{children:"COMPARE_AND_SET"})," Mode"]}),"\n",(0,s.jsxs)(n.p,{children:["There are different ",(0,s.jsx)(n.code,{children:"setConfiguration"})," modes:",(0,s.jsx)(n.code,{children:"SET"})," (default), ",(0,s.jsx)(n.code,{children:"ADD"})," and ",(0,s.jsx)(n.code,{children:"COMPARE_AND_SET"}),"."]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"SET"}),": The leader will consider the given peers in request to be the new group."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"ADD"}),": The leader will only add the new peers in request to the existing group and will not remove any existing peers."]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.code,{children:"COMPARE_AND_SET"}),": The leader will first compare between the current configuration and the provided configuration in request, and it will accept the new configuration only if the current configuration equals to the provided configuration in request. For the ",(0,s.jsx)(n.code,{children:"ADD"})," mode and the ",(0,s.jsx)(n.code,{children:"COMPARE_AND_SET"})," mode, build a ",(0,s.jsx)(n.code,{children:"SetConfigurationRequest.Arguments"})," object and then pass it to ",(0,s.jsx)(n.a,{href:"https://github.com/apache/ratis/blob/master/ratis-client/src/main/java/org/apache/ratis/client/api/AdminApi.java#L35",children:"setConfiguration(SetConfigurationRequest.Arguments)"}),"."]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"majority-add",children:"Majority-add"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Majority-add"})," is defined as below:"]}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:["Adding a majority of members in a single ",(0,s.jsx)(n.code,{children:"setConfiguration"})," request. In other words, adding ",(0,s.jsx)(n.code,{children:"n"})," members to a group of ",(0,s.jsx)(n.code,{children:"m"})," members in a ",(0,s.jsx)(n.code,{children:"setConfiguration"})," request, where ",(0,s.jsx)(n.code,{children:"n >= m"}),". Note that, when a ",(0,s.jsx)(n.code,{children:"setConfiguration"})," request removes and adds members at the same time, the majority is counted after the removal. For examples, ",(0,s.jsx)(n.code,{children:"setConfiguration"})," to a 3-member group by adding 2 new members is NOT a majority-add. However, ",(0,s.jsx)(n.code,{children:"setConfiguration"})," to a 3-member group by removing 2 of members and adding 2 new members at the same time is a majority-add. Majority-add is unsafe since it can end up in a no-leader state which cannot be recovered automatically. The following property is to enable/disable majority-add."]}),"\n"]}),"\n",(0,s.jsxs)(n.li,{children:["\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.code,{children:"raft.server.leaderelection.member.majority-add"})," (",(0,s.jsx)(n.code,{children:"boolean"}),", default=",(0,s.jsx)(n.code,{children:"false"}),")"]}),"\n"]}),"\n"]}),"\n",(0,s.jsxs)(n.p,{children:["In a monitored environment, majority-add can be enabled in order to reduce the number of ",(0,s.jsx)(n.code,{children:"setConfiguration"})," calls. As an example, change from non-HA single server to a HA 3-server group can be done in a single ",(0,s.jsx)(n.code,{children:"setConfiguration"})," call, instead of 2 ",(0,s.jsx)(n.code,{children:"setConfiguration"})," calls with majority-add disabled. In case the no-leader state problem happens, the monitor (a human or a program) can fix it by restarting the servers."]})]})}function h(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}}}]);