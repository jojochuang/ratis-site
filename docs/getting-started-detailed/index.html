<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-getting-started-detailed" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">Getting Started (Detailed) | Apache Ratis</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ratis.apache.org/ratis-site/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ratis.apache.org/ratis-site/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ratis.apache.org/ratis-site/docs/getting-started-detailed"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Getting Started (Detailed) | Apache Ratis"><meta data-rh="true" name="description" content="Let&#x27;s get started to use Raft in your application. To demonstrate how to use Ratis, we implement a simple Counter service, which maintains a counter value across a raft group. Clients could send the following types of requests to the raft group:"><meta data-rh="true" property="og:description" content="Let&#x27;s get started to use Raft in your application. To demonstrate how to use Ratis, we implement a simple Counter service, which maintains a counter value across a raft group. Clients could send the following types of requests to the raft group:"><link data-rh="true" rel="icon" href="/ratis-site/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ratis.apache.org/ratis-site/docs/getting-started-detailed"><link data-rh="true" rel="alternate" href="https://ratis.apache.org/ratis-site/docs/getting-started-detailed" hreflang="en"><link data-rh="true" rel="alternate" href="https://ratis.apache.org/ratis-site/docs/getting-started-detailed" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Getting Started (Detailed)","item":"https://ratis.apache.org/ratis-site/docs/getting-started-detailed"}]}</script><link rel="alternate" type="application/rss+xml" href="/ratis-site/blog/rss.xml" title="Apache Ratis RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ratis-site/blog/atom.xml" title="Apache Ratis Atom Feed"><link rel="stylesheet" href="/ratis-site/assets/css/styles.4cf10283.css">
<script src="/ratis-site/assets/js/runtime~main.cc38f3b7.js" defer="defer"></script>
<script src="/ratis-site/assets/js/main.a08a0bf5.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/ratis-site/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ratis-site/"><div class="navbar__logo"><img src="/ratis-site/img/logo.svg" alt="Apache Ratis Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/ratis-site/img/logo.svg" alt="Apache Ratis Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Apache Ratis</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/ratis-site/docs/overview">Documentation</a><a class="navbar__item navbar__link" href="/ratis-site/downloads">Downloads</a><a class="navbar__item navbar__link" href="/ratis-site/blog">Blog</a><a class="navbar__item navbar__link" href="/ratis-site/community">Community</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Apache Software Foundation<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><a href="https://github.com/apache/ratis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ratis-site/docs/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ratis-site/docs/about">About Apache Ratis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" href="/ratis-site/docs/getting-started-detailed">Getting Started (Detailed)</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ratis-site/docs/concepts">Concepts</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ratis-site/docs/cli">Features</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ratis-site/docs/security">Security</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ratis-site/docs/configurations">References</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ratis-site/docs/contributors/building">Contributors</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ratis-site/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Getting Started (Detailed)</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Getting Started</h1></header>
<p>Let&#x27;s get started to use Raft in your application. To demonstrate how to use Ratis, we implement a simple <em>Counter</em> service, which maintains a counter value across a raft group. Clients could send the following types of requests to the raft group:</p>
<ul>
<li><code>INCREMENT</code>: increase the counter value by 1. This command will trigger a transaction to change the state.</li>
<li><code>GET</code>: query the current value of the counter. This is a read-only command since it does not change the state.</li>
</ul>
<p>We have the following <code>enum</code> for representing the supported commands.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The supported commands the Counter example.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public enum CounterCommand {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /** Increment the counter by 1. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INCREMENT,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /** Get the counter value. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GET;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final Message message = Message.valueOf(name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Message getMessage() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return message;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /** Does the given command string match this command? */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean matches(String command) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return name().equalsIgnoreCase(command);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Note: The source code of the Counter example and the other examples is at <a href="https://github.com/apache/ratis/tree/master/ratis-examples" target="_blank" rel="noopener noreferrer">Ratis examples</a>. This article intends to show the steps of integration of Ratis. If you wish to run the Counter example please refer to <a href="https://github.com/apache/ratis/tree/master/ratis-examples#example-3-counter" target="_blank" rel="noopener noreferrer">the README</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="adding-the-dependency">Adding the Dependency<a href="#adding-the-dependency" class="hash-link" aria-label="Direct link to Adding the Dependency" title="Direct link to Adding the Dependency">​</a></h2>
<p>The first step is to add Ratis dependencies into the project. The dependencies are available in <a href="https://search.maven.org/search?q=g:org.apache.ratis" target="_blank" rel="noopener noreferrer">maven central</a>:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">ratis-server</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.ratis</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<p>Then, add one of the following transports:</p>
<ul>
<li>ratis-grpc</li>
<li>ratis-netty</li>
</ul>
<p>In this example, we choose to use ratis-grpc:</p>
<div class="language-xml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-xml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">ratis-grpc</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">artifactId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token tag punctuation" style="color:#393A34">&lt;</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain">org.apache.ratis</span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">groupId</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token tag punctuation" style="color:#393A34">&lt;/</span><span class="token tag" style="color:#00009f">dependency</span><span class="token tag punctuation" style="color:#393A34">&gt;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-the-counterstatemachine">Implementing the <code>CounterStateMachine</code><a href="#implementing-the-counterstatemachine" class="hash-link" aria-label="Direct link to implementing-the-counterstatemachine" title="Direct link to implementing-the-counterstatemachine">​</a></h2>
<p>A state machine manages the application logic. The state machine is responsible for:</p>
<ul>
<li>Apply raft log transactions in order to maintain the current state.<!-- -->
<ul>
<li>When there is an <code>INCREMENT</code> request, it will first be written to the raft log as a log entry. Once the log entry is committed, the state machine will be invoked for applying the log entry as a transaction so that the counter value will be increased by 1.</li>
<li>When there is a <code>GET</code> request, it will not be written to the raft log since it is a readonly request which does not change the state. The state machine should return the current value of the counter.</li>
</ul>
</li>
<li>Manage snapshots loading/saving.<!-- -->
<ul>
<li>Snapshots are used for log compaction so that the state machine can be restored from a snapshot and then applies only the newer log entries, instead of applying a long history of log starting from the beginning.</li>
</ul>
</li>
</ul>
<p>We discuss how to implement <code>CounterStateMachine</code> in the following subsections. The complete source code of it is in <a href="https://github.com/apache/ratis/blob/master/ratis-examples/src/main/java/org/apache/ratis/examples/counter/server/CounterStateMachine.java" target="_blank" rel="noopener noreferrer">CounterStateMachine.java</a>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="defining-the-state">Defining the State<a href="#defining-the-state" class="hash-link" aria-label="Direct link to Defining the State" title="Direct link to Defining the State">​</a></h3>
<p>In this example, the <code>CounterStateMachine</code> extends the <code>BaseStateMachine</code>, which provides a base implementation of a <code>StateMachine</code>. Inside the <code>CounterStateMachine</code>, there is a <code>counter</code> object which stores the current value. The <code>counter</code> is an <code>AtomicInteger</code> in order to support concurrent access. We use the build-in <code>SimpleStateMachineStorage</code>, which is a file-based storage implementation, as a storage for storing snapshots. The fields are shown below:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CounterStateMachine extends BaseStateMachine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final SimpleStateMachineStorage storage = new SimpleStateMachineStorage();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final AtomicInteger counter = new AtomicInteger(0);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="applying-raft-log-entries">Applying Raft Log Entries<a href="#applying-raft-log-entries" class="hash-link" aria-label="Direct link to Applying Raft Log Entries" title="Direct link to Applying Raft Log Entries">​</a></h3>
<p>Once a raft log entry has been committed (i.e. a majority of the servers have acknowledged), Ratis notifies the state machine by invoking the <code>applyTransaction</code> method. The <code>applyTransaction</code> method first validates the log entry. Then, it applies the log entry by increasing the counter value and updates the term-index. The code fragments are shown below. Note that the <code>incrementCounter</code> method is synchronized in order to update both counter and last applied term-index atomically.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CounterStateMachine extends BaseStateMachine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private synchronized int incrementCounter(TermIndex termIndex) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updateLastAppliedTermIndex(termIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return counter.incrementAndGet();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Apply the {@link CounterCommand#INCREMENT} by incrementing the counter object.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param trx the transaction context</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return the message containing the updated counter value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public CompletableFuture applyTransaction(TransactionContext trx) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final LogEntryProto entry = trx.getLogEntry();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //check if the command is valid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String command = entry.getStateMachineLogEntry().getLogData().toString(Charset.defaultCharset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CounterCommand.INCREMENT.match(command)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return JavaUtils.completeExceptionally(new IllegalArgumentException(&quot;Invalid Command: &quot; + command));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //increment the counter and update term-index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final TermIndex termIndex = TermIndex.valueOf(entry);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final long incremented = incrementCounter(termIndex);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //if leader, log the incremented value and the term-index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (trx.getServerRole() == RaftPeerRole.LEADER) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.info(&quot;{}: Increment to {}&quot;, termIndex, incremented);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //return the new value of the counter to the client</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return CompletableFuture.completedFuture(Message.valueOf(String.valueOf(incremented)));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="processing-readonly-commands">Processing Readonly Commands<a href="#processing-readonly-commands" class="hash-link" aria-label="Direct link to Processing Readonly Commands" title="Direct link to Processing Readonly Commands">​</a></h3>
<p>The <code>INCREMENT</code> command is implemented in the previous section. What about the <code>GET</code> command? Since the <code>GET</code> command is a readonly command, it is implemented by the <code>query</code> method instead of the <code>applyTransaction</code> method. The code fragment is shown below.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CounterStateMachine extends BaseStateMachine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Process {@link CounterCommand#GET}, which gets the counter value.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param request the GET request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return a {@link Message} containing the current counter value as a {@link String}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public CompletableFuture query(Message request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final String command = request.getContent().toString(Charset.defaultCharset());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!CounterCommand.GET.match(command)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return JavaUtils.completeExceptionally(new IllegalArgumentException(&quot;Invalid Command: &quot; + command));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return CompletableFuture.completedFuture(Message.valueOf(counter.toString()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="taking-snapshots">Taking Snapshots<a href="#taking-snapshots" class="hash-link" aria-label="Direct link to Taking Snapshots" title="Direct link to Taking Snapshots">​</a></h3>
<p>When taking a snapshot, the state is persisted in the storage of the state machine. The snapshot can be loaded for restoring the state in the future. In this example, we use <code>ObjectOutputStream</code> to write the counter value to a snapshot file. The term-index is stored in the file name of the snapshot file. The code fragments are shown below. Note that the <code>getState</code> method is synchronized in order to get the applied term-index and the counter value atomically. Note also that getting the counter value alone does not have to be synchronized since the <code>counter</code> field is already an <code>AtomicInteger</code>.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CounterStateMachine extends BaseStateMachine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /** The state of the {@link CounterStateMachine}. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  static class CounterState {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final TermIndex applied;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private final int counter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CounterState(TermIndex applied, int counter) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.applied = applied;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      this.counter = counter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TermIndex getApplied() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return applied;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    int getCounter() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return counter;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /** @return the current state. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private synchronized CounterState getState() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new CounterState(getLastAppliedTermIndex(), counter.get());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Store the current state as a snapshot file in the {@link #storage}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return the index of the snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public long takeSnapshot() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //get the current state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final CounterState state = getState();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final long index = state.getApplied().getIndex();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //create a file with a proper name to store the snapshot</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final File snapshotFile = storage.getSnapshotFile(state.getApplied().getTerm(), index);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //write the counter value into the snapshot file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (ObjectOutputStream out = new ObjectOutputStream(new BufferedOutputStream(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Files.newOutputStream(snapshotFile.toPath())))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      out.writeInt(state.getCounter());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (IOException ioe) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.warn(&quot;Failed to write snapshot file \&quot;&quot; + snapshotFile + &quot;\&quot;, last applied index=&quot; + state.getApplied());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //return the index of the stored snapshot (which is the last applied one)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return index;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="loading-snapshots">Loading Snapshots<a href="#loading-snapshots" class="hash-link" aria-label="Direct link to Loading Snapshots" title="Direct link to Loading Snapshots">​</a></h3>
<p>When loading a snapshot, we use an <code>ObjectInputStream</code> to read the snapshot file. The term-index is read from the file name of the snapshot file. The code fragments are shown below. Note that the <code>updateState</code> method is synchronized in order to update the applied term-index and the counter value atomically.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CounterStateMachine extends BaseStateMachine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private synchronized void updateState(TermIndex applied, int counterValue) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updateLastAppliedTermIndex(applied);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    counter.set(counterValue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Load the state of the state machine from the {@link #storage}.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param snapshot the information of the snapshot being loaded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return the index of the snapshot or -1 if snapshot is invalid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @throws IOException if it failed to read from storage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private long load(SingleFileSnapshotInfo snapshot) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //check null</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (snapshot == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.warn(&quot;The snapshot info is null.&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return RaftLog.INVALID_LOG_INDEX;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //check if the snapshot file exists.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final Path snapshotPath = snapshot.getFile().getPath();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!Files.exists(snapshotPath)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      LOG.warn(&quot;The snapshot file {} does not exist for snapshot {}&quot;, snapshotPath, snapshot);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return RaftLog.INVALID_LOG_INDEX;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //read the TermIndex from the snapshot file name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final TermIndex last = SimpleStateMachineStorage.getTermIndexFromSnapshotFile(snapshotPath.toFile());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //read the counter value from the snapshot file</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (ObjectInputStream in = new ObjectInputStream(new BufferedInputStream(Files.newInputStream(snapshotPath)))) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      counterValue = in.readInt();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //update state</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    updateState(last, counterValue);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return last.getIndex();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementing-the-initialize-and-reinitialize-methods">Implementing the <code>initialize</code> and <code>reinitialize</code> methods.<a href="#implementing-the-initialize-and-reinitialize-methods" class="hash-link" aria-label="Direct link to implementing-the-initialize-and-reinitialize-methods" title="Direct link to implementing-the-initialize-and-reinitialize-methods">​</a></h3>
<p>The <code>initialize</code> method is called at most once when the server is starting up. In contrast, the <code>reinitialize</code> method is called when 1. the server is resumed from the <code>PAUSE</code> state, or 2. a new snapshot is installed from the leader or from an external source. In <code>CounterStateMachine</code>, the <code>reinitialize</code> method simply loads the latest snapshot and the <code>initialize</code> method additionally initializes the <code>BaseStateMachine</code> super class and the storage.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class CounterStateMachine extends BaseStateMachine {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Initialize the state machine storage and then load the state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param server the server running this state machine</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param groupId the id of the {@link org.apache.ratis.protocol.RaftGroup}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param raftStorage the storage of the server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @throws IOException if it fails to load the state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void initialize(RaftServer server, RaftGroupId groupId, RaftStorage raftStorage) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    super.initialize(server, groupId, raftStorage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    storage.init(raftStorage);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reinitialize();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Simply load the state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @throws IOException if it fails to load the state.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void reinitialize() throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    load(storage.getLatestSnapshot());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="preparing-a-raftgroup">Preparing a <code>RaftGroup</code><a href="#preparing-a-raftgroup" class="hash-link" aria-label="Direct link to preparing-a-raftgroup" title="Direct link to preparing-a-raftgroup">​</a></h2>
<p>In order to run a raft group, each server must start a <code>RaftServer</code> instance, which is responsible for communicating to each other through the Raft protocol. It&#x27;s important to keep in mind that, each raft server knows the initial raft group when starting up. They know the number of raft peers in the group and the addresses of the peers. In this example, we have a raft group with 3 peers. For simplicity, each peer listens to a specific port on the same machine. The addresses of them are defined in a <a href="https://github.com/apache/ratis/blob/master/ratis-examples/src/main/resources/conf.properties" target="_blank" rel="noopener noreferrer">property file</a> as below.</p>
<div class="language-properties codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-properties codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">raft.server.address.list=127.0.0.1:10024,127.0.0.1:10124,127.0.0.1:11124</span><br></span></code></pre></div></div>
<p>The peers are named as &#x27;n0&#x27;, &#x27;n1&#x27; and &#x27;n2&#x27; and they form a <code>RaftGroup</code>. For more details, see <a href="https://github.com/apache/ratis/blob/master/ratis-examples/src/main/java/org/apache/ratis/examples/common/Constants.java" target="_blank" rel="noopener noreferrer">Constants.java</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="building--starting-the-counterserver">Building &amp; Starting the <code>CounterServer</code><a href="#building--starting-the-counterserver" class="hash-link" aria-label="Direct link to building--starting-the-counterserver" title="Direct link to building--starting-the-counterserver">​</a></h2>
<p>We use a <code>RaftServer.Builder</code> to build a <code>RaftServer</code>. We first set up a <code>RaftProperties</code> object with a local directory as the storage of the server and a port number as the gRPC server port. Then, we create our <code>CounterStateMachine</code> and pass everything to the builder as below.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public final class CounterServer implements Closeable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final RaftServer server;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public CounterServer(RaftPeer peer, File storageDir) throws IOException {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //create a property object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final RaftProperties properties = new RaftProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //set the storage directory (different for each peer) in the RaftProperty object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RaftServerConfigKeys.setStorageDir(properties, Collections.singletonList(storageDir));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //set the port (different for each peer) in RaftProperty object</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final int port = NetUtils.createSocketAddr(peer.getAddress()).getPort();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    GrpcConfigKeys.Server.setPort(properties, port);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //create the counter state machine which holds the counter value</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    final CounterStateMachine counterStateMachine = new CounterStateMachine();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    //build the Raft server</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.server = RaftServer.newBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setGroup(Constants.RAFT_GROUP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setProperties(properties)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setServerId(peer.getId())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .setStateMachine(counterStateMachine)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Now we are ready to start our <code>CounterServer</code> peers and form a raft group. The command is:</p>
<div class="language-shell codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-shell codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">java org.apache.ratis.examples.counter.server.CounterServer peer_index</span><br></span></code></pre></div></div>
<p>The argument <code>peer_index</code> must be 0, 1 or 2. After a server is started, it communicates with other peers in the group, and performs raft actions such as leader election and append-log-entries. After all three servers are started, the counter service is up and running with the Raft protocol. For more details, see <a href="https://github.com/apache/ratis/blob/master/ratis-examples/src/main/java/org/apache/ratis/examples/counter/server/CounterServer.java" target="_blank" rel="noopener noreferrer">CounterServer.java</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="building--running-the-counterclient">Building &amp; Running the <code>CounterClient</code><a href="#building--running-the-counterclient" class="hash-link" aria-label="Direct link to building--running-the-counterclient" title="Direct link to building--running-the-counterclient">​</a></h2>
<p>We use a <code>RaftGroup</code> to build a <code>RaftClient</code> and then use the <code>RaftClient</code> to send commands to the raft service. Note that gRPC is the default RPC type so that we may skip setting it in the <code>RaftProperties</code>.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public final class CounterClient implements Closeable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  private final RaftClient client = RaftClient.newBuilder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .setProperties(new RaftProperties())</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .setRaftGroup(Constants.RAFT_GROUP)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>With this raft client, we can then send commands using the <code>BlockingApi</code> returned by <code>RaftClient.io()</code>, or the <code>AsyncApi</code> returned by <code>RaftClient.async()</code>. The <code>send</code> method in the <code>BlockingApi</code>/<code>AsyncApi</code> is used to send the <code>INCREMENT</code> command as below.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">client.io().send(CounterCommand.INCREMENT.getMessage());</span><br></span></code></pre></div></div>
<p>or</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">client.async().send(CounterCommand.INCREMENT.getMessage());</span><br></span></code></pre></div></div>
<p>The <code>sendReadonly</code> method in the <code>BlockingApi</code>/<code>AsyncApi</code> is used to send the <code>GET</code> command as below.</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">client.io().sendReadOnly(CounterCommand.GET.getMessage());</span><br></span></code></pre></div></div>
<p>or</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">client.async().sendReadOnly(CounterCommand.GET.getMessage());</span><br></span></code></pre></div></div>
<p>For more details, see <a href="https://github.com/apache/ratis/blob/master/ratis-examples/src/main/java/org/apache/ratis/examples/counter/client/CounterClient.java" target="_blank" rel="noopener noreferrer">CounterClient.java</a>.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/apache/ratis-site/edit/main/docs/getting-started-detailed.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ratis-site/docs/about"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">About Apache Ratis</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ratis-site/docs/concepts"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Concepts</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#adding-the-dependency" class="table-of-contents__link toc-highlight">Adding the Dependency</a></li><li><a href="#implementing-the-counterstatemachine" class="table-of-contents__link toc-highlight">Implementing the <code>CounterStateMachine</code></a><ul><li><a href="#defining-the-state" class="table-of-contents__link toc-highlight">Defining the State</a></li><li><a href="#applying-raft-log-entries" class="table-of-contents__link toc-highlight">Applying Raft Log Entries</a></li><li><a href="#processing-readonly-commands" class="table-of-contents__link toc-highlight">Processing Readonly Commands</a></li><li><a href="#taking-snapshots" class="table-of-contents__link toc-highlight">Taking Snapshots</a></li><li><a href="#loading-snapshots" class="table-of-contents__link toc-highlight">Loading Snapshots</a></li><li><a href="#implementing-the-initialize-and-reinitialize-methods" class="table-of-contents__link toc-highlight">Implementing the <code>initialize</code> and <code>reinitialize</code> methods.</a></li></ul></li><li><a href="#preparing-a-raftgroup" class="table-of-contents__link toc-highlight">Preparing a <code>RaftGroup</code></a></li><li><a href="#building--starting-the-counterserver" class="table-of-contents__link toc-highlight">Building &amp; Starting the <code>CounterServer</code></a></li><li><a href="#building--running-the-counterclient" class="table-of-contents__link toc-highlight">Building &amp; Running the <code>CounterClient</code></a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/ratis-site/docs/intro">Documentation</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/apache-ratis" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://ratis.apache.org/mailing-lists.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Mailing Lists<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://the-asf.slack.com/archives/C01U6RE02R2" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/ratis-site/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/apache/ratis" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">ASF</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item">License<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.</div></div></div></footer></div>
</body>
</html>