<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-concepts/state-machine-snapshot" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.8.1">
<title data-rh="true">State Machine Snapshot | Apache Ratis</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://ratis.apache.org/ratis-site/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://ratis.apache.org/ratis-site/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://ratis.apache.org/ratis-site/docs/concepts/state-machine-snapshot"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="State Machine Snapshot | Apache Ratis"><meta data-rh="true" name="description" content="Overview"><meta data-rh="true" property="og:description" content="Overview"><link data-rh="true" rel="icon" href="/ratis-site/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://ratis.apache.org/ratis-site/docs/concepts/state-machine-snapshot"><link data-rh="true" rel="alternate" href="https://ratis.apache.org/ratis-site/docs/concepts/state-machine-snapshot" hreflang="en"><link data-rh="true" rel="alternate" href="https://ratis.apache.org/ratis-site/docs/concepts/state-machine-snapshot" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"State Machine Snapshot","item":"https://ratis.apache.org/ratis-site/docs/concepts/state-machine-snapshot"}]}</script><link rel="alternate" type="application/rss+xml" href="/ratis-site/blog/rss.xml" title="Apache Ratis RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/ratis-site/blog/atom.xml" title="Apache Ratis Atom Feed"><link rel="stylesheet" href="/ratis-site/assets/css/styles.81d801f5.css">
<script src="/ratis-site/assets/js/runtime~main.fcb3f8c7.js" defer="defer"></script>
<script src="/ratis-site/assets/js/main.756ece8f.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg xmlns="http://www.w3.org/2000/svg" style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t="light";var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",e||t),document.documentElement.setAttribute("data-theme-choice",e||t)}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><link rel="preload" as="image" href="/ratis-site/img/logo.svg"><div role="region" aria-label="Skip to main content"><a class="skipToContent_XQEw" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/ratis-site/"><div class="navbar__logo"><img src="/ratis-site/img/logo.svg" alt="Apache Ratis Logo" class="themedComponent_kh6W themedComponent--light_h03h"><img src="/ratis-site/img/logo.svg" alt="Apache Ratis Logo" class="themedComponent_kh6W themedComponent--dark_QNPN"></div><b class="navbar__title text--truncate">Apache Ratis</b></a><a class="navbar__item navbar__link" href="/ratis-site/docs/overview">Overview</a><a class="navbar__item navbar__link" href="/ratis-site/downloads">Downloads</a><a class="navbar__item navbar__link" href="/ratis-site/blog">Blog</a><a class="navbar__item navbar__link" href="/ratis-site/community">Community</a><a class="navbar__item navbar__link" href="/ratis-site/resources">Resources</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://www.apache.org/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Apache Software Foundation<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a><a href="https://github.com/apache/ratis" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_uCnI colorModeToggle___LX"><button class="clean-btn toggleButton_lRi6 toggleButtonDisabled_RrB2" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CvfP lightToggleIcon_za12"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CvfP darkToggleIcon_N0wT"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_CvfP systemToggleIcon_EumZ"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_s0uA"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_j14X"><div class="docsWrapper_f_1x"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_qpaQ" type="button"></button><div class="docRoot_HhoO"><aside class="theme-doc-sidebar-container docSidebarContainer_iysW"><div class="sidebarViewport_X_nh"><div class="sidebar_OeW8"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_T3hq"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ratis-site/docs/overview">Overview</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ratis-site/docs/about">About Apache Ratis</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/ratis-site/docs/getting-started-detailed">Getting Started (Detailed)</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/ratis-site/docs/concepts">Concepts</a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ratis-site/docs/concepts">Concepts</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ratis-site/docs/concepts/raft-log">Raft Log</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/ratis-site/docs/concepts/state-machine-snapshot">State Machine Snapshot</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ratis-site/docs/concepts/statemachine-storage">StateMachine Storage</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/ratis-site/docs/concepts/log-appender">Log Appender</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ratis-site/docs/cli">Features</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ratis-site/docs/developer-guide/streaming-configuration">Developer Guide</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ratis-site/docs/configurations/client">References</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/ratis-site/docs/contributors/building">Contributors</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_YndD"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_rCQN"><div class="docItemContainer_KlqD"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_pAeo" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/ratis-site/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_Ijg0"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Concepts</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">State Machine Snapshot</span></li></ul></nav><div class="tocCollapsible_AWvZ theme-doc-toc-mobile tocMobile_MZVo"><button type="button" class="clean-btn tocCollapsibleButton_JjJG">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>State Machine Snapshot</h1></header>
<h2 class="anchor anchorWithStickyNavbar_Bens" id="overview">Overview<a href="#overview" class="hash-link" aria-label="Direct link to Overview" title="Direct link to Overview">​</a></h2>
<p>Raft log grows during normal operation. As it grows larger, it occupies more space and takes more time to replay. Therefore, some form of log compaction is necessary for practical systems. In Ratis, we introduce snapshot mechanism as the way to do log compaction. The basic idea of snapshot is to create and save a snapshot reflecting the latest state of the state machine, and then delete previous logs up to the checkpoint.</p>
<h2 class="anchor anchorWithStickyNavbar_Bens" id="implement-snapshot">Implement snapshot<a href="#implement-snapshot" class="hash-link" aria-label="Direct link to Implement snapshot" title="Direct link to Implement snapshot">​</a></h2>
<p>To enable snapshot, we have to first implement the following two methods in <code>StateMachine</code>:</p>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Dump the in-memory state into a snapshot file in the RaftStorage. The</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * StateMachine implementation can decide 1) its own snapshot format, 2) when</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * a snapshot is taken, and 3) how the snapshot is taken (e.g., whether the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * snapshot blocks the state machine, and whether to purge log entries after</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * a snapshot is done).</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The snapshot should include the latest raft configuration.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @return the largest index of the log entry that has been applied to the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * state machine and also included in the snapshot. Note the log purge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * should be handled separately.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">long takeSnapshot() throws IOException;</span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Returns the information for the latest durable snapshot.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SnapshotInfo getLatestSnapshot();</span><br></span></code></pre></div></div>
<p>Snapshotting for memory-based state machines is conceptually simple. In snapshotting, the entire current system state is written to a snapshot on stable storage. With disk-based state machines, a recent copy of the system state is maintained on disk as part of normal operation. Thus, the Raft log can be discarded as soon as the state machine reflects writes to disk, and snapshotting is used only when sending consistent disk images to other servers. Examples of snapshot implementation can be found at <a href="https://github.com/apache/ratis/blob/master/ratis-examples/src/main/java/org/apache/ratis/examples/arithmetic/ArithmeticStateMachine.java" target="_blank" rel="noopener noreferrer">https://github.com/apache/ratis/blob/master/ratis-examples/src/main/java/org/apache/ratis/examples/arithmetic/ArithmeticStateMachine.java</a>.</p>
<h2 class="anchor anchorWithStickyNavbar_Bens" id="trigger-a-snapshot">Trigger a snapshot<a href="#trigger-a-snapshot" class="hash-link" aria-label="Direct link to Trigger a snapshot" title="Direct link to Trigger a snapshot">​</a></h2>
<p>To trigger a snapshot, we can either</p>
<ul>
<li>Trigger snapshot manually using <code>SnapshotManagementApi</code>. Note that Ratis imposes a minimal creation gap between two subsequent snapshot creation:</li>
</ul>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">// SnapshotManagementApi</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftClientReply create(long timeoutMs) throws IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftClientReply create(boolean force, long timeoutMs) throws IOException;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftClientReply create(long creationGap, long timeoutMs) throws IOException;</span><br></span></code></pre></div></div>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">// customize snapshot creation gap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServerConfigKeys.Snapshot.setCreationGap(properties, 1024L);</span><br></span></code></pre></div></div>
<ul>
<li>Enable triggering snapshot automatically when log size exceeds limit (in number of applied log entries). To do so, we may turn on the auto-trigger-snapshot option in RaftProperties and set an appropriate triggering threshold.</li>
</ul>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">RaftServerConfigKeys.Snapshot.setAutoTriggerEnabled(properties, true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RaftServerConfigKeys.Snapshot.setAutoTriggerThreshold(properties, 400000);</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_Bens" id="purge-obsolete-logs-after-snapshot">Purge obsolete logs after snapshot<a href="#purge-obsolete-logs-after-snapshot" class="hash-link" aria-label="Direct link to Purge obsolete logs after snapshot" title="Direct link to Purge obsolete logs after snapshot">​</a></h2>
<p>When a snapshot is taken, Ratis will automatically discard obsolete logs. By default, Ratis will purge logs up to min(snapshot index, safe index), where safe index equals to the minimal commit index of all group members. In other words, if a log is committed by all group members and is included in the latest snapshot, then this log can be safely deleted. Sometimes we can choose to aggressively purge the logs up to the snapshot index even if some peers do not have commit index up to snapshot index. To do this, we can turn on the purge-up-to-snapshot-index option in RaftProperties:</p>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">RaftServerConfigKeys.Log.setPurgeUptoSnapshotIndex(properties, true);</span><br></span></code></pre></div></div>
<p>Purging the logs up to snapshot index sometimes leads to unnecessary burst of network bandwidth. That is, even if a follower lags behind only a few logs, the leader still needs to transfer the full snapshot. To avoid this situation, we can preserve some recent logs when purging logs up to snapshot index. To do this, we can set the number of logs to be preserved when purging in RaftProperties:</p>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">RaftServerConfigKeys.Log.setPurgePreservationLogNum(properties, n);</span><br></span></code></pre></div></div>
<p>Intuitively, cost of transferring n logs shall equal the cost of transferring the full snapshot.</p>
<h2 class="anchor anchorWithStickyNavbar_Bens" id="retain-multiple-versions-of-snapshot">Retain multiple versions of snapshot<a href="#retain-multiple-versions-of-snapshot" class="hash-link" aria-label="Direct link to Retain multiple versions of snapshot" title="Direct link to Retain multiple versions of snapshot">​</a></h2>
<p>Ratis allows <code>StateMachine</code> to retain multiple versions of snapshot. To enable this feature, we have to:</p>
<ol>
<li>Set how many number of versions to retain in RaftProperties when building the RaftServer:</li>
</ol>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">RaftServerConfigKeys.Snapshot.setRetentionFileNum(properties, 2);</span><br></span></code></pre></div></div>
<ol start="2">
<li>Implement <code>StateMachineStorage.cleanupOldSnapshots</code> to clean up old versions of snapshot:</li>
</ol>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">// StateMachineStorage.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void cleanupOldSnapshots(SnapshotRetentionPolicy snapshotRetentionPolicy) throws IOException;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_Bens" id="load-the-latest-snapshot">Load the latest snapshot<a href="#load-the-latest-snapshot" class="hash-link" aria-label="Direct link to Load the latest snapshot" title="Direct link to Load the latest snapshot">​</a></h2>
<ol>
<li>When a RaftServer restarts and tries to recover the data, it first has to read and load the latest snapshot, and then apply the logs not included in the snapshot. We have to implement snapshot loading in <code>StateMachine.initialize</code> lifecycle hook.</li>
</ol>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Initializes the State Machine with the given parameter.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * The state machine must, if there is any, read the latest snapshot.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void initialize(RaftServer raftServer, RaftGroupId raftGroupId, RaftStorage storage) throws IOException;</span><br></span></code></pre></div></div>
<ol start="2">
<li>When a RaftServer newly joins an existing cluster, it has first to obtain the latest snapshot and install it locally. Before installing a snapshot, <code>StateMachine.pause</code> hook is called to ensure that a new snapshot can be installed.</li>
</ol>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">/*</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Pauses the state machine. On return, the state machine should have closed all open files so</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * that a new snapshot can be installed.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void pause();</span><br></span></code></pre></div></div>
<p>After installing the snapshot, <code>StateMachine.reinitialize</code> is called. We shall initialize the state machine with the latest installed snapshot in this lifecycle hook.</p>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Re-initializes the State Machine in PAUSED state. The</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * state machine is responsible reading the latest snapshot from the file system (if any) and</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * initialize itself with the latest term and index there including all the edits.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">void reinitialize() throws IOException;</span><br></span></code></pre></div></div>
<h2 class="anchor anchorWithStickyNavbar_Bens" id="customize-snapshot-storage-path">Customize snapshot storage path<a href="#customize-snapshot-storage-path" class="hash-link" aria-label="Direct link to Customize snapshot storage path" title="Direct link to Customize snapshot storage path">​</a></h2>
<p>By default, Ratis assumes <code>StateMachine</code> snapshot files be placed under <code>RaftStorageDirectory.getStateMachineDir()</code>. When leader installs a snapshot to the follower, Ratis will keep the snapshot layout in follower side unchanged relative to this directory. That is, the installed snapshot under follower&#x27;s state machine directory will have the same hierarchy as in the leader side. <code>StateMachine</code> can also customize the snapshot storage and install directory. To do this, we may provide the snapshot storage root directory in <code>StateMachineStorage</code>, together with a temporary directory holding in-transmitting snapshot files.</p>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">// StateMachineStorage</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/** @return the state machine directory. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default File getSnapshotDir() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">/** @return the temporary directory. */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default File getTmpDir() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return null;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Examples of customizing snapshot storage path can be found at <a href="https://github.com/apache/ratis/blob/master/ratis-server/src/test/java/org/apache/ratis/InstallSnapshotFromLeaderTests.java" target="_blank" rel="noopener noreferrer">https://github.com/apache/ratis/blob/master/ratis-server/src/test/java/org/apache/ratis/InstallSnapshotFromLeaderTests.java</a></p>
<h2 class="anchor anchorWithStickyNavbar_Bens" id="customize-snapshot-installation">Customize snapshot installation<a href="#customize-snapshot-installation" class="hash-link" aria-label="Direct link to Customize snapshot installation" title="Direct link to Customize snapshot installation">​</a></h2>
<p>When a new follower joins the cluster, leader will install the latest snapshot to the follower. <code>StateMachine</code> only needs to provide the <code>SnapshotInfo</code> of the latest snapshot, and it&#x27;s Ratis&#x27; responsibility to handle all the nuances of dividing snapshot into chunks / transferring chunks / validating checksum. This default implementation works well in most scenarios. However, there are scenarios where the default implementation cannot satisfy. To name a few:</p>
<ol>
<li><code>StateMachine</code> has a flexible snapshot layout with files scattering around different directories.</li>
<li>Follower wants to fully utilize underling topology. For example, follower may download the snapshot from the nearest follower instead of the leader.</li>
<li>Follower wants to download snapshot from different sources in parallel.</li>
</ol>
<p>Ratis provides <code>InstallSnapshotNotification</code> to let <code>StateMachine</code> take over the full control of snapshot installation. To enable this feature, we may first turn off the leader-install-snapshot option to disable leader explicitly installing snapshot to follower:</p>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">RaftServerConfigKeys.Log.Appender.setInstallSnapshotEnabled(properties, false);</span><br></span></code></pre></div></div>
<p>After this option is disabled, Whenever the leader detects that a follower needs snapshot, instead of installing snapshot to that follower, leader will only send a snapshot installation notification. It&#x27;s now the follower&#x27;s responsibility to install the latest snapshot asynchronously. To do this, we have to implement <code>FollowerEventApi.notifyInstallSnapshotFromLeader</code>:</p>
<div class="language-java codeBlockContainer_agNB theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_EAfz"><pre tabindex="0" class="prism-code language-java codeBlock_qpae thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines___Jb"><span class="token-line" style="color:#393A34"><span class="token plain">interface FollowerEventApi {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  /**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * Notify the {@link StateMachine} that the leader has purged entries from its log.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * In order to catch up, the {@link StateMachine} has to install the latest snapshot asynchronously.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param roleInfoProto information about the current node role and rpc delay information.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @param firstTermIndexInLog The term-index of the first append entry available in the leader&#x27;s log.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   * @return return the last term-index in the snapshot after the snapshot installation.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  default CompletableFuture notifyInstallSnapshotFromLeader(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      RoleInfoProto roleInfoProto,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TermIndex firstTermIndexInLog) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return CompletableFuture.completedFuture(null);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre></div></div>
<p>Examples of <code>notifyInstallSnapshotFromLeader</code> implementation can be found at <a href="https://github.com/apache/ratis/blob/master/ratis-server/src/test/java/org/apache/ratis/InstallSnapshotNotificationTests.java" target="_blank" rel="noopener noreferrer">https://github.com/apache/ratis/blob/master/ratis-server/src/test/java/org/apache/ratis/InstallSnapshotNotificationTests.java</a></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/apache/ratis-site/edit/main/docs/concepts/state-machine-snapshot.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Tp1m" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_Z5q7"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/ratis-site/docs/concepts/raft-log"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Raft Log</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/ratis-site/docs/concepts/statemachine-storage"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">StateMachine Storage</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_Cr5v thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#overview" class="table-of-contents__link toc-highlight">Overview</a></li><li><a href="#implement-snapshot" class="table-of-contents__link toc-highlight">Implement snapshot</a></li><li><a href="#trigger-a-snapshot" class="table-of-contents__link toc-highlight">Trigger a snapshot</a></li><li><a href="#purge-obsolete-logs-after-snapshot" class="table-of-contents__link toc-highlight">Purge obsolete logs after snapshot</a></li><li><a href="#retain-multiple-versions-of-snapshot" class="table-of-contents__link toc-highlight">Retain multiple versions of snapshot</a></li><li><a href="#load-the-latest-snapshot" class="table-of-contents__link toc-highlight">Load the latest snapshot</a></li><li><a href="#customize-snapshot-storage-path" class="table-of-contents__link toc-highlight">Customize snapshot storage path</a></li><li><a href="#customize-snapshot-installation" class="table-of-contents__link toc-highlight">Customize snapshot installation</a></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/ratis-site/docs/intro">Documentation</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/ratis-site/community#mailing-lists">Mailing Lists</a></li><li class="footer__item"><a href="https://the-asf.slack.com/archives/CD4QREQD7" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slack<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://issues.apache.org/jira/projects/RATIS/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Jira<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/ratis-site/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/apache/ratis" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">ASF</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://www.apache.org/licenses/" target="_blank" rel="noopener noreferrer" class="footer__link-item">License<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/sponsorship.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Sponsorship<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.apache.org/foundation/thanks.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Thanks<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://www.apache.org/security/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Security<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://privacy.apache.org/policies/privacy-policy-public.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" class="iconExternalLink_umhF"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 The Apache Software Foundation. Licensed under the Apache License, Version 2.0.</div></div></div></footer></div>
</body>
</html>